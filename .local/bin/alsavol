#!/bin/sh

reload() {
	CURVOL=$(amixer -M get Master | awk '/Mono.+/ {print $6=="[off]"?$6:$4}' | tr -d '[]')
}

listen() {
    firstrun=0

    stdbuf -oL alsactl monitor | {
        while true; do
            {
                if [ $firstrun -eq 0 ]
                then
                    firstrun=1
                else
                    read -r event || break
                    if ! echo "$event" | grep -e "Playback"
                    then
                        continue
                    fi
                fi
            } >/dev/null
            output
        done
    }
}

output() {
	reload
	if [ "${CURVOL}" = "off" ]
	then
		echo " Mute"
	else
		echo " $CURVOL"
	fi
}

case $1 in
	up)
		amixer -q -M set Master 5%+
		;;
	down)
		amixer -q -M set Master 5%-
		;;
	tgle)
		amixer -q set Master toggle
		;;
	listn)
		listen
		;;
	*)
		output
		;;
esac
