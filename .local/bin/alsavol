#!/bin/zsh

reload() {
	CURVOL=$(amixer -M get Master | awk '/Mono.+/ {print $6=="[off]"?$6:$4}' | tr -d '[]')
}

evnt() {
	alsactl monitor > "$HOME/.local/share/evnt"
}

listen() {
    firstrun=0

    evnt | {
        while true; do
            {
                # If this is the first time just continue
                # and print the current state
                # Otherwise wait for events
                # This is to prevent the module being empty until
                # an event occurs
                if [ $firstrun -eq 0 ]
                then
                    firstrun=1
                else
		    break
                    if ! grep -e "Playback" -e "node" "$HOME/.local/share/evnt"
                    then
                        # Avoid double events
			continue
                    fi
                fi
            } &>/dev/null
    	    output
            #echo "" > "$HOME/.local/share/evnt"
        done
    }
}

output() {
	reload
	if [ "${CURVOL}" = "off" ]
	then
		echo " Mute"
	else
		echo " $CURVOL"
	fi
}

case $1 in
	up)
		amixer -q -M set Master 5%+
		;;
	down)
		amixer -q -M set Master 5%-
		;;
	tgle)
		amixer -q set Master toggle
		;;
	listn)
		listen
		;;
	*)
		output
		;;
esac
